environment:
  host:
    os: 'linux'                                                         # used to verify at runtime that correct host pool is being used
  runtime:
    provider: 'appcontainer'                                            # Currently only appcontainer is supported future will bring oscontainer and virtualmachine
    image: 'microsoft/dotnet:2.2-sdk'                                   # This is the image that your pipeline will run in.

signing_options:
  profile: 'internal_azure_service'   # This service deploys to Azure!

workspace_options:
  enable_legacy_networking: true    # Default is false. If false, only the Restore stage enables network connectivity to the user build container.
                                    # If true, all stages enable network connectivity to user build container.

version:
  name: 'Liftr.IncrediBuild'
  major: 0                                                              # The major version number.
  minor: 9                                                              # The minor version number
  system: 'buildrevision'

package_sources:
  nuget:
    config_files:                               # A list of glob patterns specifying the configuration files. Use this if you already have NuGet.Config files in your repository.
      - include:                                # Configuration files to include for automatic inference.
        - "src/NuGet.Config"

restore:
  commands:
    - !!defaultcommand
      name: 'Restore Dependencies'
      command: 'build/liftr-run-linux-restore.sh'

build:
  commands:
    - !!buildcommand
      name: 'Build service'
      command: 'build/liftr-run-linux-build.sh'

test:
  commands:
    - !!testcommand
      name: 'Run Tests'
      command: 'build/liftr-run-linux-tests.sh'
      testresults:
        - title: 'Tests'
          type: 'vstest'
          platform: 'Any CPU'
          configuration: 'Debug'
          include:
            - '**/*.trx'

package:
  commands:
    - !!buildcommand
      name: 'Package nugests and web projects'
      command: 'build/liftr-run-linux-pack.sh'
    - !!dockerbuildcommand
      name: 'Build docker image'
      context_folder: 'src/Liftr.IncrediBuild.RP.Web'
      repository_name: 'ibuild-rp-web'
      latest: false # Don't push the :latest tag since every deployment should refer to a build number.
      publish_build_tag: true
      metadata_file:
        local_path: '.docker-images/gatewayWeb.json'  # folder name '.docker-images' cannot be changed
                                                  # 'gatewayWeb' match the chart parameter name
        artifact_path: 'docker-images/gatewayWeb.json'
    - !!buildcommand
      name: 'Pack EV2 shell extension'
      command: 'build/liftr-run-linux-pack-ev2-ext.sh'
      artifacts:
        - from: 'out-ev2'
          to: 'ev2'
          include:
            - '**/*'
    - !!buildcommand
      name: 'Pack EV2 base image shell extension'
      command: 'build/liftr-run-linux-pack-baseimage.sh'
      artifacts:
        - from: 'out-base-image'
          to: 'ev2-base-image'
          include:
            - '**/*'

static_analysis_options: # OPTIONAL: If you wish to add options to FxCop, ModernCop, PoliCheck, or BinSkim
  binskim_options:       # OPTIONAL: If you want to add options for BinSkim.
    files_to_scan:
      - from: 'src/**/bin'
        include:
          - '**/Microsoft.Liftr.*.dll'